import os
import sqlite3
import re
import asyncio
import logging
from pathlib import Path
from dotenv import load_dotenv
from telethon import TelegramClient, events

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ (.env) â€“ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ API-ĞºĞ»ÑÑ‡Ğ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load_dotenv()
API_ID = int(os.getenv("API_ID"))
API_HASH = os.getenv("API_HASH")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²-ÑĞ¿Ğ¸ÑĞºĞ¾Ğ² Ğ¸Ğ· ĞºĞ¾Ñ€Ğ½Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
#    â€¢ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºĞ¸-ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸ (# â€¦)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ROOT_DIR = Path(__file__).resolve().parent.parent     # ĞºĞ¾Ñ€Ğ½ĞµĞ²Ğ°Ñ Ğ¿Ğ°Ğ¿ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°


def read_list_file(filename: str) -> list[str]:
    filepath = ROOT_DIR / filename
    with open(filepath, encoding="utf-8") as f:
        return [
            line.strip()
            for line in f
            if line.strip() and not line.strip().startswith("#")
        ]


# 3. ĞŸĞ¾Ğ´Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞºĞ¸ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
SOURCE_CHATS = read_list_file("source_chats.txt")          # ĞºĞ°Ğ½Ğ°Ğ»Ñ‹-Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸
TARGET_CHATS = read_list_file("target_chats.txt")          # Ñ‡Ğ°Ñ‚Ñ‹-Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ĞµĞ»Ğ¸
KEYWORDS = read_list_file("keywords.txt")                  # Â«Ğ¿Ğ»ÑÑÂ»-Ñ„Ñ€Ğ°Ğ·Ñ‹/regex
EXCLUDE_PATTERNS = read_list_file("exclude_patterns.txt")  # Â«Ğ¼Ğ¸Ğ½ÑƒÑÂ»-Ñ„Ñ€Ğ°Ğ·Ñ‹/regex

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ±Ğ°Ğ·Ñ‹ SQLite (Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğµ message_id)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DB_PATH = ROOT_DIR / "parser_db.sqlite"
conn = sqlite3.connect(DB_PATH)
cursor = conn.cursor()
cursor.execute(
    """
    CREATE TABLE IF NOT EXISTS parsed_messages (
        message_id INTEGER,
        chat_id TEXT,
        PRIMARY KEY (message_id)
    )
    """
)
conn.commit()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
logging.basicConfig(
    filename=ROOT_DIR / "job_bot.log",
    level=logging.INFO,
    format="%(asctime)s | %(levelname)s | %(message)s",
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6. Telegram-ĞºĞ»Ğ¸ĞµĞ½Ñ‚
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
client = TelegramClient("session", API_ID, API_HASH)


@client.on(events.NewMessage(chats=SOURCE_CHATS))
async def handler(event):
    """
    ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¸Ğ· SOURCE_CHATS:
      â€¢ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼, ĞµÑĞ»Ğ¸ ÑƒĞ¶Ğµ Ğ² Ğ‘Ğ”
      â€¢ Ğ¾Ñ‚Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼, ĞµÑĞ»Ğ¸ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ»ÑĞ±ÑƒÑ Â«Ğ¼Ğ¸Ğ½ÑƒÑÂ»-Ñ„Ñ€Ğ°Ğ·Ñƒ
      â€¢ Ğ¿ĞµÑ€ĞµÑÑ‹Ğ»Ğ°ĞµĞ¼, ĞµÑĞ»Ğ¸ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ñƒ Â«Ğ¿Ğ»ÑÑÂ»-Ñ„Ñ€Ğ°Ğ·Ñƒ
    """
    msg_id = event.message.id
    chat_id = str(event.chat_id)
    text = event.message.message or ""

    # Ğ£Ğ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾?
    cursor.execute(
        "SELECT 1 FROM parsed_messages WHERE message_id = ? AND chat_id = ?",
        (msg_id, chat_id),
    )
    if cursor.fetchone():
        return

    text_lower = text.lower()

    # ĞœĞ¸Ğ½ÑƒÑ-Ñ„Ñ€Ğ°Ğ·Ñ‹
    if any(re.search(pat, text_lower, re.IGNORECASE) for pat in EXCLUDE_PATTERNS):
        logging.info(f"[Ğ¡ĞšĞ˜ĞŸ] âŒ Ğ¼Ğ¸Ğ½ÑƒÑ-Ñ„Ñ€Ğ°Ğ·Ğ° Ğ² {msg_id}")
        return

    # ĞŸĞ»ÑÑ-Ñ„Ñ€Ğ°Ğ·Ñ‹
    if any(re.search(pat, text_lower, re.IGNORECASE) for pat in KEYWORDS):
        for target in TARGET_CHATS:
            try:
                await client.send_message(target, f"ğŸ’¼ Ğ’Ğ°ĞºĞ°Ğ½ÑĞ¸Ñ:\n\n{text}")
                logging.info(f"[OK] {msg_id} â†’ {target}")
            except Exception as exc:
                logging.error(f"[ĞĞ¨Ğ˜Ğ‘ĞšĞ] {msg_id} â†’ {target}: {exc}")
        cursor.execute(
            "INSERT INTO parsed_messages (message_id, chat_id) VALUES (?, ?)",
            (msg_id, chat_id),
        )
        conn.commit()
    else:
        logging.info(f"[Ğ¡ĞšĞ˜ĞŸ] ğŸš« Ğ½ĞµÑ‚ ĞºĞ»ÑÑ‡ĞµĞ¹ Ğ² {msg_id}")


async def main():
    client.start()                       # Ğ±ĞµĞ· await â€“ start() Ğ½Ğµ coroutine
    logging.info("ğŸš€ Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½")
    await client.run_until_disconnected()


if __name__ == "__main__":
    asyncio.run(main())
